<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title></title>
	<meta name="description" content="Awesome!!!">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script type="text/javascript" src="//code.jquery.com/jquery-1.11.1.js"></script>
</head>
<body>
	<span id="url">Loading...</span>
	<span id="title"></span>
	<span id="desc"></span>


<script type="text/javascript">

var N8 = N8 || {}; // Global namespace

// Helper functions / library
N8.lib = {
	jsonp: function(url) {
		var script = document.createElement('script');
		script.src = url;
		script.type = 'text/javascript';
		script.async = true;
		script.onload = script.remove;
		document.getElementsByTagName('body')[0].appendChild(script);
	},
};

// Short URL object
N8.surl = (function () {
	var links = [];

	function base_convert(number, frombase, tobase) {
		return parseInt(number + '', frombase | 0).toString(tobase | 0); // max radix = 36
	}
	function store_links(data) {
		links = data;
		var hash = document.location.search.substr(1);
		if (hash.length > 0) lookup( hash );
		delete N8.surl.store_links;
	}
	function lookup (key) {
		var link = links[ base_convert( key, 36, 10 ) ];
		document.getElementById('url').innerHTML = '<a href="' + link + '" target="_blank">' + link + '</a>';
		N8.lib.jsonp('http://anyorigin.com/dev/get/?url=' + encodeURIComponent(link) + '&callback=N8.surl._page_meta'); // thanks anyorigin.com
	}
	function page_meta (data) {
		// title
		var titles = /<title>([^<]*)<\/title>/gi.exec(data.contents);
		if (titles) $('#title').html(titles[1]);

		// description
		var descs = /meta content="([^"]*)" name="description"/gi.exec(data.contents);
		    descs = descs || /meta name="description" content="([^"]*)"/gi.exec(data.contents);
		if (descs) $('#desc').html(descs[1]);
	}

	// TODO: promices so this is possible
	function awesome_lookup (key) {
		return {
			link: 'http://google.com/',
			title: 'Google',
			desc: 'blah blah blah',
		};
	}

	// Main
	N8.lib.jsonp('https://gist.githubusercontent.com/bign8/12ca258d3fee92c2e307/raw/links.js'); // callback=N8.surl.store_links

	return {
		store_links: store_links, // destroyed after initial use
		lookup: lookup,
		_page_meta: page_meta,
	};
})();

</script>

</body>
</html>
